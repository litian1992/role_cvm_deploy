# SPDX-License-Identifier: MIT
---
# NOTE: This test requires an unpartitioned block device of type "disk"
# to be present on the target host (e.g. a second virtual disk in a VM).
# The test skips automatically when no such device is found.
- name: Ensure disk encryption works when cvm_deploy_encrypt_disk is enabled
  hosts: all
  gather_facts: false
  vars:
    cvm_deploy_trustee_gc: false
    cvm_deploy_encrypt_disk: true
    cvm_deploy_encrypt_disk_mount_point: /mnt/encrypted-disk
  tasks:
    - name: Check for an unpartitioned disk device
      ansible.builtin.shell: |
        set -o pipefail
        lsblk -n -o NAME,TYPE,PKNAME | awk '
          $2=="disk" && $1 !~ /^zram|^loop|^dm/ { disk=$1; haspart[disk]=0 }
          $2=="part" { parent=$3; if (parent in haspart) haspart[parent]=1 }
          END {
            for (d in haspart) {
              if (haspart[d] == 0) {
                print d
                exit 0
              }
            }
          }
        '
      register: __test_unpartitioned_disk
      changed_when: false
      failed_when: false

    - name: Set fact when no unpartitioned disk is available
      ansible.builtin.set_fact:
        __test_skip_encrypt_assertions: "{{ __test_unpartitioned_disk.stdout | trim == '' }}"

    - name: Run cvm_deploy role with disk encryption enabled
      ansible.builtin.include_role:
        name: linux-system-roles.cvm_deploy
      when: not __test_skip_encrypt_assertions

    - name: Stat the encrypted disk mount point
      ansible.builtin.stat:
        path: "{{ cvm_deploy_encrypt_disk_mount_point }}"
      register: __test_mount_point
      when: not __test_skip_encrypt_assertions

    - name: Assert mount point directory exists
      ansible.builtin.assert:
        that:
          - __test_mount_point.stat.exists
          - __test_mount_point.stat.isdir
        fail_msg: >-
          Encrypted disk mount point
          {{ cvm_deploy_encrypt_disk_mount_point }} does not exist
      when: not __test_skip_encrypt_assertions

    - name: Get mount information
      ansible.builtin.command: findmnt --noheadings --output SOURCE {{ cvm_deploy_encrypt_disk_mount_point }}
      register: __test_findmnt
      changed_when: false
      failed_when: false
      when: not __test_skip_encrypt_assertions

    - name: Assert the encrypted disk is mounted
      ansible.builtin.assert:
        that:
          - __test_findmnt.rc == 0
          - __test_findmnt.stdout | trim != ""
        fail_msg: >-
          Nothing is mounted at {{ cvm_deploy_encrypt_disk_mount_point }}
      when: not __test_skip_encrypt_assertions

    - name: Assert the mounted device is the LUKS mapper device
      ansible.builtin.assert:
        that:
          - >-
            '/dev/mapper/encrypted-disk' in
            (__test_findmnt.stdout | trim)
        fail_msg: >-
          Expected /dev/mapper/encrypted-disk to be mounted at
          {{ cvm_deploy_encrypt_disk_mount_point }} but found:
          {{ __test_findmnt.stdout }}
      when: not __test_skip_encrypt_assertions

    - name: Stat the LUKS mapper device
      ansible.builtin.stat:
        path: /dev/mapper/encrypted-disk
      register: __test_mapper_dev
      when: not __test_skip_encrypt_assertions

    - name: Assert LUKS mapper device exists
      ansible.builtin.assert:
        that:
          - __test_mapper_dev.stat.exists
        fail_msg: "LUKS mapper device /dev/mapper/encrypted-disk does not exist"
      when: not __test_skip_encrypt_assertions

    - name: Assert encrypted_disk_key fact was set
      ansible.builtin.assert:
        that:
          - encrypted_disk_key is defined
          - encrypted_disk_key | length > 0
        fail_msg: "encrypted_disk_key fact was not set by the role"
      when: not __test_skip_encrypt_assertions

    - name: Stat podman storage directory on encrypted disk
      ansible.builtin.stat:
        path: "{{ cvm_deploy_encrypt_disk_mount_point }}/containers-storage"
      register: __test_containers_storage
      when: not __test_skip_encrypt_assertions

    - name: Assert podman storage directory was created on encrypted disk
      ansible.builtin.assert:
        that:
          - __test_containers_storage.stat.exists
          - __test_containers_storage.stat.isdir
        fail_msg: >-
          Podman storage directory
          {{ cvm_deploy_encrypt_disk_mount_point }}/containers-storage
          was not created
      when: not __test_skip_encrypt_assertions

    - name: Read podman storage config
      ansible.builtin.slurp:
        src: /etc/containers/storage.conf
      register: __test_storage_conf
      when: not __test_skip_encrypt_assertions

    - name: Assert podman storage config points to encrypted disk
      ansible.builtin.assert:
        that:
          - >-
            cvm_deploy_encrypt_disk_mount_point in
            (__test_storage_conf.content | b64decode)
        fail_msg: >-
          /etc/containers/storage.conf does not reference the encrypted
          disk mount point {{ cvm_deploy_encrypt_disk_mount_point }}
      when: not __test_skip_encrypt_assertions
