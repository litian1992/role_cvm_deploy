# SPDX-License-Identifier: MIT
---
# Record state before the role, run the role with trustee_gc disabled, then
# assert the role did not add any quadlet files or create /etc/trustee-gc.
# This works in batch mode when a previous test (e.g. tests_default) already
# left quadlet files on the host.
- name: Ensure role is a no-op when cvm_deploy_trustee_gc is disabled
  hosts: all
  gather_facts: false
  vars:
    cvm_deploy_trustee_gc: false
    cvm_deploy_encrypt_disk: false
    cvm_deploy_quadlet_install_dir: "/etc/containers/systemd"
  tasks:
    - name: Stat quadlet install directory (before role)
      ansible.builtin.stat:
        path: "{{ cvm_deploy_quadlet_install_dir }}"
      register: __test_quadlet_dir_before

    - name: Find quadlet files before role run
      ansible.builtin.find:
        paths: "{{ cvm_deploy_quadlet_install_dir }}"
        patterns:
          - "*.container"
          - "*.volume"
          - "*.network"
          - "*.kube"
          - "*.pod"
      register: __test_quadlet_files_before
      when: __test_quadlet_dir_before.stat.exists

    - name: Stat trustee-gc config directory (before role)
      ansible.builtin.stat:
        path: /etc/trustee-gc
      register: __test_trustee_gc_dir_before

    - name: Run role with trustee_gc disabled
      ansible.builtin.include_role:
        name: linux-system-roles.cvm_deploy
      vars:
        cvm_deploy_trustee_gc: false
        cvm_deploy_encrypt_disk: false

    - name: Stat quadlet install directory (after role)
      ansible.builtin.stat:
        path: "{{ cvm_deploy_quadlet_install_dir }}"
      register: __test_quadlet_dir_after

    - name: Find quadlet files after role run
      ansible.builtin.find:
        paths: "{{ cvm_deploy_quadlet_install_dir }}"
        patterns:
          - "*.container"
          - "*.volume"
          - "*.network"
          - "*.kube"
          - "*.pod"
      register: __test_quadlet_files_after
      when: __test_quadlet_dir_after.stat.exists

    - name: Stat trustee-gc config directory (after role)
      ansible.builtin.stat:
        path: /etc/trustee-gc
      register: __test_trustee_gc_dir_after

    - name: Assert role did not add any quadlet files
      ansible.builtin.assert:
        that:
          - >-
            (__test_quadlet_files_after.files | default([]) | map(attribute='path') | sort | list) ==
            (__test_quadlet_files_before.files | default([]) | map(attribute='path') | sort | list)
        fail_msg: >-
          Role with cvm_deploy_trustee_gc false added or removed quadlet
          files (expected no change)

    - name: Assert role did not create trustee-gc config directory
      ansible.builtin.assert:
        that:
          - >-
            (not __test_trustee_gc_dir_after.stat.exists) or
            __test_trustee_gc_dir_before.stat.exists
        fail_msg: >-
          Trustee GC config directory /etc/trustee-gc was created by the
          role even though cvm_deploy_trustee_gc is false
